<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Campania Rail Simulator Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background: #2c3e50; }
        #map { height: 100vh; width: 100%; }
        
        .panel {
            position: absolute; top: 10px; left: 10px; z-index: 1000;
            background: rgba(255, 255, 255, 0.95); padding: 15px; border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); width: 300px;
        }
        .clock { font-size: 32px; font-weight: bold; text-align: center; display: block; color: #2c3e50; font-family: monospace; }
        .time-controls { display: flex; flex-direction: column; gap: 8px; margin: 10px 0; }
        .inputs { display: flex; gap: 5px; }
        input { flex: 1; padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
        .btn-group { display: flex; gap: 4px; }
        button { flex: 1; padding: 8px 2px; cursor: pointer; border: none; background: #3498db; color: white; border-radius: 4px; font-size: 11px; }
        button:hover { background: #2980b9; }
        .btn-now { background: #27ae60; font-weight: bold; }
    </style>
</head>
<body>

<div class="panel">
    <span class="clock" id="txt-ora">00:00:00</span>
    
    <div class="time-controls">
        <div class="inputs">
            <input type="date" id="input-data" onchange="syncTime()">
            <input type="time" id="input-ora" step="1" onchange="syncTime()">
        </div>
        <button class="btn-now" onclick="resetToNow()">üïí TORNA AL PRESENTE</button>
        <div class="btn-group">
            <button onclick="setSpeed(-10)">‚è™ x10</button>
            <button onclick="togglePause()" id="btn-pausa">‚è∏ Pausa</button>
            <button onclick="setSpeed(1)">‚ñ∂Ô∏è 1x</button>
            <button onclick="setSpeed(10)">x10 ‚è©</button>
            <button onclick="setSpeed(100)">x100</button>
        </div>
    </div>
    <div id="status" style="font-size: 11px; color: #666;">Caricamento dati...</div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/bbecquet/Leaflet.RotatedMarker/leaflet.rotatedMarker.js"></script>

<script>
    // --- 1. CONFIGURAZIONE DATI TRENI (da e656.net) ---
    const databaseTreni = [
        {
            nome: "Regionale 21345",
            linea: "Ferrovia Napoli-Salerno", // Nome nel file binari
            fermate: [
                { stazione: "Napoli Centrale", arr: "17:00", part: "17:05" },
                { stazione: "Portici-Ercolano", arr: "17:15", part: "17:16" },
                { stazione: "Torre del Greco", arr: "17:22", part: "17:23" },
                { stazione: "Salerno", arr: "18:00", part: "18:05" }
            ]
        }
    ];

    // --- 2. INIZIALIZZAZIONE MAPPA ---
    const map = L.map('map').setView([40.85, 14.27], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let virtualTime = new Date();
    let multiplier = 1;
    let paused = false;

    // --- 3. MOTORE DEL TEMPO ---
    function syncTime() {
        const d = document.getElementById('input-data').value;
        const t = document.getElementById('input-ora').value;
        if(d && t) { virtualTime = new Date(d + 'T' + t); paused = true; updateUI(); }
    }

    function resetToNow() {
        virtualTime = new Date(); multiplier = 1; paused = false; updateUI();
    }

    function togglePause() { paused = !paused; document.getElementById('btn-pausa').innerText = paused ? "‚ñ∂Ô∏è Play" : "‚è∏ Pausa"; }
    function setSpeed(s) { multiplier = s; paused = false; }

    function updateUI() {
        document.getElementById('txt-ora').innerText = virtualTime.toLocaleTimeString();
        document.getElementById('input-data').value = virtualTime.toISOString().split('T')[0];
        document.getElementById('input-ora').value = virtualTime.toTimeString().split(' ')[0];
    }

    setInterval(() => {
        if (!paused) {
            virtualTime.setSeconds(virtualTime.getSeconds() + multiplier);
            updateUI();
        }
    }, 1000);

    const toSec = (t) => t.split(':').reduce((h, m) => h * 3600 + m * 60);

    // --- 4. CARICAMENTO GEOJSON E LOGICA TRENI ---
    Promise.all([
        fetch('Campania.geojson').then(r => r.json()),
        fetch('Stazioni_Campania.geojson').then(r => r.json())
    ]).then(([binari, stazioni]) => {
        
        document.getElementById('status').innerText = "Dati pronti. Simulazione avviata.";
        
        // Disegna i binari
        L.geoJSON(binari, { style: { color: '#34495e', weight: 2, opacity: 0.3 } }).addTo(map);

        databaseTreni.forEach(treno => {
            const percorsoObj = binari.features.find(f => f.properties.name === treno.linea);
            if (percorsoObj) startTrain(percorsoObj, treno, stazioni);
        });
    });

    function startTrain(lineaGeo, dati, stazioniGeo) {
        const icon = L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/725/725304.png', iconSize: [25, 25] });
        const marker = L.marker([0,0], { icon: icon, rotationAngle: 0 }).addTo(map);

        setInterval(() => {
            const adesso = virtualTime.getHours() * 3600 + virtualTime.getMinutes() * 60 + virtualTime.getSeconds();
            let currentPos = null;
            let currentBearing = 0;

            for (let i = 0; i < dati.fermate.length - 1; i++) {
                const f1 = dati.fermate[i];
                const f2 = dati.fermate[i+1];

                const t_arr1 = toSec(f1.arr), t_part1 = toSec(f1.part);
                const t_arr2 = toSec(f2.arr);

                // Trova le coordinate delle stazioni nel tuo file stazioni
                const s1 = stazioniGeo.features.find(s => s.properties.name === f1.stazione);
                const s2 = stazioniGeo.features.find(s => s.properties.name === f2.stazione);

                if (s1 && s2) {
                    // Calcola la posizione delle stazioni lungo la linea (distanza in km)
                    const dist1 = turf.nearestPointOnLine(lineaGeo, s1).properties.location;
                    const dist2 = turf.nearestPointOnLine(lineaGeo, s2).properties.location;

                    // FERMO IN STAZIONE
                    if (adesso >= t_arr1 && adesso <= t_part1) {
                        currentPos = turf.along(lineaGeo, dist1);
                        break;
                    }
                    // IN VIAGGIO
                    if (adesso > t_part1 && adesso < t_arr2) {
                        const progress = (adesso - t_part1) / (t_arr2 - t_part1);
                        const actualDist = dist1 + (dist2 - dist1) * progress;
                        currentPos = turf.along(lineaGeo, actualDist);
                        const nextPos = turf.along(lineaGeo, actualDist + 0.02);
                        currentBearing = turf.bearing(currentPos, nextPos);
                        break;
                    }
                }
            }

            if (currentPos) {
                marker.setOpacity(1);
                const c = currentPos.geometry.coordinates;
                marker.setLatLng([c[1], c[0]]);
                marker.setRotationAngle(currentBearing + 90);
            } else {
                marker.setOpacity(0);
            }
        }, 1000);
    }
</script>
</body>
</html>
