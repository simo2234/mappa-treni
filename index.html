<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mappa Ferroviaria Campania Live</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/gh/bbecquet/Leaflet.RotatedMarker/leaflet.rotatedMarker.js"></script>

    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #map { height: 100vh; width: 100%; z-index: 1; }

        /* Pannello di controllo stile Travic */
        .control-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            width: 250px;
        }

        .clock {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            text-align: center;
            margin-bottom: 10px;
            display: block;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            gap: 5px;
        }

        button {
            cursor: pointer;
            padding: 8px;
            border: none;
            background: #3498db;
            color: white;
            border-radius: 4px;
            flex: 1;
            font-size: 12px;
        }

        button:hover { background: #2980b9; }
        .status-text { font-size: 11px; color: #7f8c8d; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="control-panel">
        <span class="clock" id="virtual-clock">00:00:00</span>
        <div class="controls">
            <button onclick="changeSpeed(-10)">⏪ x10</button>
            <button onclick="togglePause()" id="pause-btn">⏸ Pausa</button>
            <button onclick="changeSpeed(1)">▶️ 1x</button>
            <button onclick="changeSpeed(10)">x10 ⏩</button>
        </div>
        <div class="status-text" id="status">Caricamento binari...</div>
    </div>

    <div id="map"></div>

    <script>
        // --- 1. CONFIGURAZIONE MAPPA ---
        const map = L.map('map').setView([40.8518, 14.2681], 9);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap'
        }).addTo(map);

        // --- 2. LOGICA DEL TEMPO (TIME MACHINE) ---
        let virtualTime = new Date();
        let timeMultiplier = 1;
        let isPaused = false;

        setInterval(() => {
            if (!isPaused) {
                virtualTime.setSeconds(virtualTime.getSeconds() + timeMultiplier);
                document.getElementById('virtual-clock').innerText = virtualTime.toLocaleTimeString();
            }
        }, 1000);

        function togglePause() {
            isPaused = !isPaused;
            document.getElementById('pause-btn').innerText = isPaused ? "▶️ Play" : "⏸ Pausa";
        }

        function changeSpeed(speed) {
            timeMultiplier = speed;
            isPaused = false;
        }

        // --- 3. CARICAMENTO DATI E BINARI ---
        fetch('Campania.geojson')
            .then(response => response.json())
            .then(geojsonData => {
                document.getElementById('status').innerText = "Binari caricati. Treno in attesa...";
                
                // Disegna la rete ferroviaria Campania di sfondo
                L.geoJSON(geojsonData, {
                    style: { color: '#bdc3c7', weight: 1.5, opacity: 0.5 }
                }).addTo(map);

                // CERCA LA LINEA: Assicurati che il nome "Ferrovia Napoli-Salerno" 
                // sia presente nel tuo file GeoJSON sotto "name"
                const lineaNapoliSalerno = geojsonData.features.find(f => 
                    f.properties.name === "Ferrovia Napoli-Salerno" || f.properties.ref === "L1"
                );

                if (lineaNapoliSalerno) {
                    creaTrenoRegionale(lineaNapoliSalerno, "Regionale 21345", 17, 0, 17, 45);
                } else {
                    document.getElementById('status').innerText = "Errore: Linea Napoli-Salerno non trovata!";
                }
            })
            .catch(err => {
                document.getElementById('status').innerText = "Errore: File GeoJSON non trovato!";
            });

        // --- 4. FUNZIONE CREAZIONE TRENO ---
        function creaTrenoRegionale(geoJsonPath, nomeTreno, hPartenza, mPartenza, hArrivo, mArrivo) {
            const trainIcon = L.icon({
                iconUrl: 'https://cdn-icons-png.flaticon.com/512/725/725304.png',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });

            const marker = L.marker([0, 0], { icon: trainIcon, rotationAngle: 0 }).addTo(map);
            const pathLength = turf.length(geoJsonPath, { units: 'kilometers' });

            // Orari convertiti in secondi per facilitare i calcoli
            const startTimeSec = hPartenza * 3600 + mPartenza * 60;
            const endTimeSec = hArrivo * 3600 + mArrivo * 60;

            setInterval(() => {
                const nowSec = virtualTime.getHours() * 3600 + virtualTime.getMinutes() * 60 + virtualTime.getSeconds();

                if (nowSec >= startTimeSec && nowSec <= endTimeSec) {
                    marker.setOpacity(1);
                    
                    // Calcolo progresso (da 0 a 1)
                    const progress = (nowSec - startTimeSec) / (endTimeSec - startTimeSec);
                    const currentDist = pathLength * progress;

                    // Calcolo posizione e rotazione con Turf.js
                    const currentPos = turf.along(geoJsonPath, currentDist, { units: 'kilometers' });
                    const nextPos = turf.along(geoJsonPath, currentDist + 0.05, { units: 'kilometers' });
                    
                    const bearing = turf.bearing(currentPos, nextPos);
                    const coords = currentPos.geometry.coordinates;

                    marker.setLatLng([coords[1], coords[0]]);
                    marker.setRotationAngle(bearing + 90); // +90 corregge l'orientamento dell'icona
                    marker.bindTooltip(nomeTreno, { permanent: false, direction: "top" });
                } else {
                    marker.setOpacity(0); // Nascondi se non è orario di viaggio
                }
            }, 1000);
        }
    </script>
</body>
</html>
