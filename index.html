<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mappa Ferroviaria Campania Live</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/gh/bbecquet/Leaflet.RotatedMarker/leaflet.rotatedMarker.js"></script>

    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #map { height: 100vh; width: 100%; z-index: 1; }

        /* Pannello di controllo stile Travic */
        .control-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            width: 250px;
        }

        .clock {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            text-align: center;
            margin-bottom: 10px;
            display: block;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            gap: 5px;
        }

        button {
            cursor: pointer;
            padding: 8px;
            border: none;
            background: #3498db;
            color: white;
            border-radius: 4px;
            flex: 1;
            font-size: 12px;
        }

        button:hover { background: #2980b9; }
        .status-text { font-size: 11px; color: #7f8c8d; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="control-panel">
        <span class="clock" id="virtual-clock">00:00:00</span>
        <div class="controls">
            <button onclick="changeSpeed(-10)">⏪ x10</button>
            <button onclick="togglePause()" id="pause-btn">⏸ Pausa</button>
            <button onclick="changeSpeed(1)">▶️ 1x</button>
            <button onclick="changeSpeed(10)">x10 ⏩</button>
        </div>
        <div class="status-text" id="status">Caricamento binari...</div>
    </div>

    <div id="map"></div>

    <script>
        // --- 1. CONFIGURAZIONE MAPPA ---
        const map = L.map('map').setView([40.8518, 14.2681], 9);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap'
        }).addTo(map);

        // --- 2. LOGICA DEL TEMPO (TIME MACHINE) ---
        let virtualTime = new Date();
        let timeMultiplier = 1;
        let isPaused = false;

        setInterval(() => {
            if (!isPaused) {
                virtualTime.setSeconds(virtualTime.getSeconds() + timeMultiplier);
                document.getElementById('virtual-clock').innerText = virtualTime.toLocaleTimeString();
            }
        }, 1000);

        function togglePause() {
            isPaused = !isPaused;
            document.getElementById('pause-btn').innerText = isPaused ? "▶️ Play" : "⏸ Pausa";
        }

        function changeSpeed(speed) {
            timeMultiplier = speed;
            isPaused = false;
        }
// --- DATABASE TRENI ---
// Aggiungi qui i treni: basta copiare e incollare una riga
    const databaseTreni = [
    {
        nome: "REGIONALE ",
        linea: "Napoli-Salerno",
        fermate: [
            { nome: "Napoli Centrale", arrivo: "10:00", partenza: "10:05" },
            { nome: "Portici-Ercolano", arrivo: "10:15", partenza: "10:17" },
            { nome: "Torre del Greco",  arrivo: "10:25", partenza: "10:27" },
            { nome: "Torre Annunziata", arrivo: "10:35", partenza: "10:37" },
            { nome: "Pompei",           arrivo: "10:45", partenza: "10:47" },
            { nome: "Salerno",          arrivo: "11:00", partenza: "11:05" }
        ]
    }
];
];
        // --- 3. CARICAMENTO DATI E BINARI ---
        fetch('campania_binari.geojson')
    .then(res => res.json())
    .then(geojsonData => {
        // Disegna i binari una sola volta
        L.geoJSON(geojsonData, { style: { color: '#bdc3c7', weight: 1.5, opacity: 0.5 } }).addTo(map);

        // CICLO AUTOMATICO: Per ogni treno nel database...
        databaseTreni.forEach(datiTreno => {
            
            // Trova la linea corretta nel GeoJSON per questo treno
            const lineaCorretta = geojsonData.features.find(f => 
                f.properties.name === datiTreno.linea
            );

            if (lineaCorretta) {
                // Avvia il treno (usiamo la funzione che abbiamo creato prima)
                creaTrenoAutomatico(lineaCorretta, datiTreno);
            }
        });
    });

// Funzione universale che gestisce qualsiasi treno
function creaTrenoConFermate(percorso, datiTreno) {
    const marker = L.marker([0, 0], { icon: iconaTreno }).addTo(map);
    const lunghezzaTotale = turf.length(percorso, { units: 'kilometers' });

    // Funzione per convertire "HH:MM" in secondi
    const toSec = (t) => t.split(':').reduce((h, m) => h * 3600 + m * 60);

    setInterval(() => {
        const adesso = virtualTime.getHours() * 3600 + virtualTime.getMinutes() * 60 + virtualTime.getSeconds();
        const fermate = datiTreno.fermate;
        
        let posAttuale = null;
        let stato = "Fuori servizio";

        for (let i = 0; i < fermate.length - 1; i++) {
            const fAttuale = fermate[i];
            const fSuccessiva = fermate[i+1];

            const partA = toSec(fAttuale.partenza);
            const arrB = toSec(fSuccessiva.arrivo);
            const arrA = toSec(fAttuale.arrivo);

            // 1. IL TRENO È FERMO IN STAZIONE?
            if (adesso >= arrA && adesso <= partA) {
                const progressoStazione = i / (fermate.length - 1);
                posAttuale = turf.along(percorso, lunghezzaTotale * progressoStazione);
                stato = "Fermo a: " + fAttuale.nome;
                break;
            }

            // 2. IL TRENO È IN VIAGGIO TRA DUE STAZIONI?
            if (adesso > partA && adesso < arrB) {
                const durataTratto = arrB - partA;
                const tempoTrascorso = adesso - partA;
                const progressoTratto = tempoTrascorso / durataTratto;

                // Calcoliamo la fetta di binari tra le due stazioni
                const inizioKms = (i / (fermate.length - 1)) * lunghezzaTotale;
                const fineKms = ((i + 1) / (fermate.length - 1)) * lunghezzaTotale;
                const kmsAttuali = inizioKms + (fineKms - inizioKms) * progressoTratto;

                posAttuale = turf.along(percorso, kmsAttuali);
                stato = "In viaggio verso: " + fSuccessiva.nome;
                break;
            }
        }

        if (posAttuale) {
            marker.setOpacity(1);
            const coords = posAttuale.geometry.coordinates;
            marker.setLatLng([coords[1], coords[0]]);
            marker.setTooltipContent(`<b>${datiTreno.nome}</b><br>${stato}`);
        } else {
            marker.setOpacity(0);
        }
    }, 1000);
}
    </script>
</body>
</html>
