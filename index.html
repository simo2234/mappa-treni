<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Campania Railway Control</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
        #map { height: 100vh; width: 100%; }
        
        .panel {
            position: absolute; top: 15px; left: 50px; z-index: 1000;
            background: white; padding: 15px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); width: 260px;
        }
        .clock { font-size: 28px; font-weight: bold; text-align: center; display: block; color: #2c3e50; }
        .controls { display: flex; justify-content: space-between; margin-top: 10px; gap: 5px; }
        button { flex: 1; padding: 8px; cursor: pointer; border: none; background: #3498db; color: white; border-radius: 5px; font-size: 11px; }
        button:hover { background: #2980b9; }
        .train-info { margin-top: 10px; font-size: 12px; color: #7f8c8d; border-top: 1px solid #eee; padding-top: 10px; }
    </style>
</head>
<body>

<div class="panel">
    <span class="clock" id="txt-ora">00:00:00</span>
    <div class="controls">
        <button onclick="setSpeed(-10)">⏪ x10</button>
        <button onclick="togglePause()" id="btn-pausa">⏸ Pausa</button>
        <button onclick="setSpeed(1)">▶️ 1x</button>
        <button onclick="setSpeed(10)">x10 ⏩</button>
        <button onclick="setSpeed(100)">x100</button>
    <div style="margin-top:10px;">
        <input type="date" id="input-data" onchange="aggiornaDataOra()">
        <input type="time" id="input-ora" step="1" onchange="aggiornaDataOra()">
    </div>

    <div class="controls">
        </div>
</div>
    </div>
    <div id="status" class="train-info">Caricamento binari...</div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/bbecquet/Leaflet.RotatedMarker/leaflet.rotatedMarker.js"></script>

<script>
    // Funzione per cambiare il tempo della mappa in base agli input
function aggiornaDataOra() {
    const dataScelta = document.getElementById('input-data').value; // Es: "2023-10-25"
    const oraScelta = document.getElementById('input-ora').value;   // Es: "14:30:00"

    if (dataScelta && oraScelta) {
        // Creiamo un nuovo oggetto data unendo le stringhe
        tempoVirtuale = new Date(dataScelta + 'T' + oraScelta);
        
        // Mettiamo in pausa per permettere all'utente di guardare quel momento preciso
        inPausa = true;
        document.getElementById('btn-pausa').innerText = "▶️ Play";
        
        // Forza l'aggiornamento immediato del clock
        document.getElementById('txt-ora').innerText = tempoVirtuale.toLocaleTimeString();
    }
}

// Opzionale: Imposta i selettori sull'ora attuale al caricamento della pagina
window.onload = () => {
    const oraDoc = new Date();
    document.getElementById('input-data').value = oraDoc.toISOString().split('T')[0];
    document.getElementById('input-ora').value = oraDoc.toTimeString().split(' ')[0];
};
    // --- DATABASE TRENI: AGGIUNGI QUI I TUOI TRENI ---
    const databaseTreni = [
        {
            nome: "Regionale Campania Express 1",
            linea: "Ferrovia Napoli-Salerno", // Deve corrispondere al 'name' nel GeoJSON
            fermate: [
                { nome: "Napoli Centrale", arrivo: "17:00", partenza: "17:05" },
                { nome: "Portici",          arrivo: "17:15", partenza: "17:17" },
                { nome: "Torre del Greco",  arrivo: "17:25", partenza: "17:27" },
                { nome: "Pompei",           arrivo: "17:40", partenza: "17:42" },
                { nome: "Salerno",          arrivo: "18:00", partenza: "18:05" }
            ]
        },
        {
            nome: "Regionale 2",
            linea: "Ferrovia Napoli-Salerno",
            fermate: [
                { nome: "Napoli Centrale", arrivo: "18:30", partenza: "18:35" },
                { nome: "Salerno",          arrivo: "19:30", partenza: "19:35" }
            ]
        }
    ];

    // --- CONFIGURAZIONE MAPPA ---
    const map = L.map('map').setView([40.8518, 14.2681], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // --- MOTORE DEL TEMPO ---
    let tempoVirtuale = new Date();
    let moltiplicatore = 1;
    let inPausa = false;

    setInterval(() => {
        if (!inPausa) {
            tempoVirtuale.setSeconds(tempoVirtuale.getSeconds() + moltiplicatore);
            document.getElementById('txt-ora').innerText = tempoVirtuale.toLocaleTimeString();
        }
    }, 1000);

    function togglePause() { inPausa = !inPausa; document.getElementById('btn-pausa').innerText = inPausa ? "▶️ Play" : "⏸ Pausa"; }
    function setSpeed(v) { moltiplicatore = v; inPausa = false; }
    const toSec = (t) => t.split(':').reduce((h, m) => h * 3600 + m * 60);

    // --- CARICAMENTO BINARI E AVVIO TRENI ---
    fetch('Campania.geojson')
        .then(res => res.json())
        .then(data => {
            document.getElementById('status').innerHTML = "Binari pronti. Treni in servizio: " + databaseTreni.length;
            
            // Disegna binari
            L.geoJSON(data, { style: { color: '#bdc3c7', weight: 2, opacity: 0.5 } }).addTo(map);

            // Per ogni treno nel database, cerca il percorso e avvialo
            databaseTreni.forEach(infoTreno => {
                const percorso = data.features.find(f => f.properties.name === infoTreno.linea);
                if (percorso) {
                    creaTreno(percorso, infoTreno);
                } else {
                    console.warn("Linea non trovata per: " + infoTreno.nome);
                }
            });
        });

    function creaTreno(geoJsonLinea, dati) {
        const icona = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/725/725304.png',
            iconSize: [30, 30], iconAnchor: [15, 15]
        });

        const marker = L.marker([0, 0], { icon: icona, rotationAngle: 0 }).addTo(map);
        const lunghezzaTotale = turf.length(geoJsonLinea, { units: 'kilometers' });

        setInterval(() => {
            const adesso = tempoVirtuale.getHours() * 3600 + tempoVirtuale.getMinutes() * 60 + tempoVirtuale.getSeconds();
            let posAttuale = null;
            let bearing = 0;
            let infoStato = "In deposito";

            for (let i = 0; i < dati.fermate.length - 1; i++) {
                const fA = dati.fermate[i];
                const fB = dati.fermate[i+1];
                
                const arrA = toSec(fA.arrivo), partA = toSec(fA.partenza);
                const arrB = toSec(fB.arrivo), partB = toSec(fB.partenza);

                // STATO 1: Fermo in stazione
                if (adesso >= arrA && adesso <= partA) {
                    const dist = (i / (dati.fermate.length - 1)) * lunghezzaTotale;
                    posAttuale = turf.along(geoJsonLinea, dist);
                    infoStato = "Fermo a: " + fA.nome;
                    break;
                }

                // STATO 2: In viaggio tra A e B
                if (adesso > partA && adesso < arrB) {
                    const progressoTratto = (adesso - partA) / (arrB - partA);
                    const distInizio = (i / (dati.fermate.length - 1)) * lunghezzaTotale;
                    const distFine = ((i + 1) / (dati.fermate.length - 1)) * lunghezzaTotale;
                    const distAttuale = distInizio + (distFine - distInizio) * progressoTratto;

                    posAttuale = turf.along(geoJsonLinea, distAttuale);
                    const posAvanti = turf.along(geoJsonLinea, distAttuale + 0.05);
                    bearing = turf.bearing(posAttuale, posAvanti);
                    infoStato = "In viaggio verso: " + fB.nome;
                    break;
                }
            }

            if (posAttuale) {
                marker.setOpacity(1);
                const c = posAttuale.geometry.coordinates;
                marker.setLatLng([c[1], c[0]]);
                marker.setRotationAngle(bearing + 90);
                marker.bindTooltip(`<b>${dati.nome}</b><br>${infoStato}`, {sticky: true});
            } else {
                marker.setOpacity(0);
            }
        }, 1000);
    }
</script>

</body>
</html>
