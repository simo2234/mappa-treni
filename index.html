<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Train Map - Italia</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body, html { margin: 0; padding: 0; height: 100%; }
        #map { height: 100vh; width: 100%; }
        .info-box {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            font-family: Arial, sans-serif;
        }
    </style>
</head>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/bbecquet/Leaflet.RotatedMarker/leaflet.rotatedMarker.js"></script>
<body>

    <div class="info-box">
        <b>Monitoraggio Treni</b><br>
        Stato: <span id="status">In aggiornamento...</span>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // 1. Inizializzazione Mappa centrata sull'Italia
        const map = L.map('map').setView([41.9028, 12.4964], 6);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // 2. Caricamento Stazioni (dal file stazioni.json che hai creato)
        fetch('stazioni.json')
            .then(response => response.json())
            .then(stazioni => {
                stazioni.forEach(s => {
                    const lat = s.stop_lat || s.lat;
                    const lon = s.stop_lon || s.lon;
                    const nome = s.stop_name || s.name;
                    
                    L.circleMarker([lat, lon], {
                        radius: 3,
                        color: '#3388ff',
                        fillOpacity: 0.5
                    }).addTo(map).bindPopup(nome);
                });
                document.getElementById('status').innerText = "Stazioni caricate";
            })
            .catch(err => {
                console.error("Errore stazioni:", err);
                document.getElementById('status').innerText = "Errore dati stazioni";
            });

        // 3. Esempio di Treno in movimento (Logica Interpolazione)
        // In un progetto reale, questi dati arriverebbero da 'orari_treni.json'
        const trenoEsempio = {
            id: "FR 9604",
            partenza: { lat: 41.9009, lon: 12.5020, ora: "14:00" }, // Roma
            arrivo: { lat: 45.4847, lon: 9.2048, ora: "17:00" }     // Milano
        };

        const markerTreno = L.marker([trenoEsempio.partenza.lat, trenoEsempio.partenza.lon], {
            icon: L.icon({
                iconUrl: 'https://cdn-icons-png.flaticon.com/512/725/725304.png', // Icona treno
                iconSize: [30, 30]
            })
        }).addTo(map);

        function muoviTreno() {
            const oraAttuale = new Date();
            const oraInSecondi = oraAttuale.getHours() * 3600 + oraAttuale.getMinutes() * 60 + oraAttuale.getSeconds();

            const parseOra = (hms) => {
                const [h, m] = hms.split(':').map(Number);
                return h * 3600 + m * 60;
            };

            const tInizio = parseOra(trenoEsempio.partenza.ora);
            const tFine = parseOra(trenoEsempio.arrivo.ora);

            if (oraInSecondi >= tInizio && oraInSecondi <= tFine) {
                // Calcolo percentuale viaggio
                const pct = (oraInSecondi - tInizio) / (tFine - tInizio);
                
                // Calcolo nuova posizione (lineare)
                const dLat = trenoEsempio.partenza.lat + (trenoEsempio.arrivo.lat - trenoEsempio.partenza.lat) * pct;
                const dLon = trenoEsempio.partenza.lon + (trenoEsempio.arrivo.lon - trenoEsempio.partenza.lon) * pct;
                
                markerTreno.setLatLng([dLat, dLon]);
                markerTreno.bindPopup(`<b>${trenoEsempio.id}</b><br>In viaggio verso Milano`).openPopup();
            } else {
                markerTreno.setOpacity(0); // Nascondi se fuori orario
            }
        }

        // Aggiorna la posizione ogni secondo
        setInterval(muoviTreno, 1000);

    </script>
</body>
// 1. Inizializza la mappa sulla Campania
const map = L.map('map').setView([40.8518, 14.2681], 9);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// 2. Carica il file GeoJSON della Campania
fetch('campania.geojson')
    .then(response => response.json())
    .then(data => {
        // Disegna tutti i binari in grigio (sfondo)
        L.geoJSON(data, {
            style: { color: '#bdc3c7', weight: 2, opacity: 0.5 }
        }).addTo(map);

        // 3. ESTRAZIONE PERCORSO: Cerchiamo la linea specifica
        // NOTA: 'name' deve corrispondere a quello che c'è nel tuo file
        const featureLinea = data.features.find(f => 
            f.properties.name === "Ferrovia Napoli-Salerno" || f.properties.ref === "L2"
        );

        if (featureLinea) {
            avviaAnimazioneTreno(featureLinea);
        } else {
            console.error("Linea non trovata! Controlla i nomi nel file GeoJSON.");
        }
    });

function avviaAnimazioneTreno(geoJsonLinea) {
    // Crea l'icona del treno
    const iconaTreno = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/725/725304.png',
        iconSize: [30, 30],
        iconAnchor: [15, 15]
    });

    const markerTreno = L.marker([0, 0], { icon: iconaTreno, rotationAngle: 0 }).addTo(map);
    const linea = geoJsonLinea.geometry;
    const distanzaTotale = turf.length(geoJsonLinea, { units: 'kilometers' });

    function muovi() {
        const ora = new Date();
        const adesso = ora.getHours() * 3600 + ora.getMinutes() * 60 + ora.getSeconds();

        // Esempio: Il treno parte alle 16:30 e arriva alle 17:15
        const inizio = 16 * 3600 + 30 * 60; 
        const fine = 17 * 3600 + 15 * 60;

        if (adesso >= inizio && adesso <= fine) {
            const progresso = (adesso - inizio) / (fine - inizio);
            const distanzaPercorsa = distanzaTotale * progresso;

            // Punto attuale
            const punto = turf.along(geoJsonLinea, distanzaPercorsa, { units: 'kilometers' });
            // Punto leggermente avanti per calcolare la rotazione
            const puntoAvanti = turf.along(geoJsonLinea, distanzaPercorsa + 0.1, { units: 'kilometers' });
            
            const bearing = turf.bearing(punto, puntoAvanti);
            const [lon, lat] = punto.geometry.coordinates;

            markerTreno.setLatLng([lat, lon]);
            if (markerTreno.setRotationAngle) {
                markerTreno.setRotationAngle(bearing + 90); // +90 dipende dall'orientamento dell'immagine
            }
            markerTreno.bindPopup("<b>Treno Regionale Campania</b><br>In viaggio...").openPopup();
        } else {
            markerTreno.setOpacity(0); // Nascondi se non è orario di viaggio
        }
    }

    setInterval(muovi, 1000); // Aggiorna ogni secondo
}
</html>
